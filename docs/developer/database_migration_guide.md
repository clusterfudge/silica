# Database Migration Guide - Developer Activities

## Table of Contents
- [Quick Start](#quick-start)
- [Daily Development Tasks](#daily-development-tasks)
- [Schema Changes](#schema-changes)
- [Database Management](#database-management)
- [Collaboration Workflows](#collaboration-workflows)
- [Testing & Debugging](#testing--debugging)
- [Production Considerations](#production-considerations)
- [Troubleshooting](#troubleshooting)

## Quick Start

### First Time Setup
```bash
# 1. Clone repository and setup environment
git clone <repository>
cd silica
uv sync

# 2. Check if database needs setup
silica cron migrate status
# Expected output:
# ⚠️  Cron database needs migration
#    Run: silica cron migrate upgrade

# 3. Apply all existing migrations
silica cron migrate upgrade
# Expected output:
# Upgrading cron database to head...
# INFO [alembic.runtime.migration] Running upgrade -> 5d8b746712b6, initial_cron_schema

# 4. Verify database is ready
silica cron migrate status
# Expected output:
# ✅ Cron database is up to date

# 5. Start development
silica cron --bind-port 8080
# Application starts with fully migrated database
```

### Verify Your Setup
```bash
# Check database file exists
ls -la silica-cron.db
# Should show: -rw-r--r-- silica-cron.db

# Inspect database schema
sqlite3 silica-cron.db ".tables"
# Should show: cron_alembic_version, job_executions, prompts, scheduled_jobs

# Check migration history
silica cron migrate history
# Shows all applied migrations
```

## Daily Development Tasks

### Starting Work on Existing Project
```bash
# 1. Pull latest changes
git pull origin main

# 2. Update dependencies
uv sync

# 3. Check if new migrations were added
silica cron migrate status

# If migrations needed:
silica cron migrate upgrade
# Applies any new migrations from other developers

# 4. Start development
silica cron
```

### Checking Database Status
```bash
# Quick status check
silica cron migrate status
# Possible outputs:
# ✅ Cron database is up to date           (ready for development)
# ⚠️  Cron database needs migration       (run upgrade first)

# Detailed migration information
silica cron migrate current
# Shows: 34065a4cc718 (head)

silica cron migrate history
# Shows complete migration timeline:
# fc0bfa77ff5a -> 34065a4cc718 (head), add priority field to prompts
# 5d8b746712b6 -> fc0bfa77ff5a, add new feature
# <base> -> 5d8b746712b6, initial_cron_schema
```

### Inspecting Database Contents
```bash
# View database schema
sqlite3 silica-cron.db ".schema"
# Shows complete database structure

# View specific table schema
sqlite3 silica-cron.db ".schema prompts"
# Shows:
# CREATE TABLE prompts (
#   id INTEGER NOT NULL,
#   name VARCHAR(255) NOT NULL,
#   ...
# );

# Query data
sqlite3 silica-cron.db "SELECT * FROM prompts;"
# Shows actual data in prompts table

# Check migration version
sqlite3 silica-cron.db "SELECT * FROM cron_alembic_version;"
# Shows: 34065a4cc718

# Interactive SQL session
sqlite3 silica-cron.db
# Opens interactive sqlite shell
# sqlite> .tables
# sqlite> SELECT * FROM prompts;
# sqlite> .quit
```

## Schema Changes

### Adding a New Column
This is the most common schema change developers make.

**Step 1: Modify the Model**
```python
# Edit silica/cron/models/prompt.py
class Prompt(Base):
    __tablename__ = "prompts"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(255), nullable=False, index=True)
    description = Column(Text)
    prompt_text = Column(Text, nullable=False)
    model = Column(String(50), nullable=False, default="haiku")
    persona = Column(String(50), nullable=False, default="basic_agent")
    
    # NEW: Add priority field
    priority = Column(Integer, nullable=False, default=1, 
                     comment="Priority: 1=low, 2=medium, 3=high")
    
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

**Step 2: Generate Migration**
```bash
silica cron migrate create "add priority field to prompts"
# Output:
# Generating /path/to/silica/cron/alembic/versions/20250817_0824_34065a4cc718_add_priority_field_to_prompts.py ... done
# INFO [alembic.autogenerate.compare] Detected added column 'prompts.priority'
# ✅ Migration created successfully
#    Review the generated migration file before applying
```

**Step 3: Review Generated Migration**
```python
# Check the generated file: silica/cron/alembic/versions/20250817_0824_*_add_priority_field_to_prompts.py
"""add priority field to prompts

Revision ID: 34065a4cc718
Revises: fc0bfa77ff5a
Create Date: 2025-08-17 08:24:55.246092
"""
from alembic import op
import sqlalchemy as sa

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('prompts', sa.Column('priority', sa.Integer(), nullable=False))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('prompts', 'priority')
    # ### end Alembic commands ###
```

**Step 4: Apply Migration**
```bash
silica cron migrate upgrade
# Output:
# Upgrading cron database to head...
# INFO [alembic.runtime.migration] Running upgrade fc0bfa77ff5a -> 34065a4cc718, add priority field to prompts
```

**Step 5: Verify Changes**
```bash
# Check database schema
sqlite3 silica-cron.db ".schema prompts"
# Should now include: priority INTEGER NOT NULL

# Test the application
silica cron --bind-port 8080
# Application should start normally with new schema
```

### Modifying an Existing Column
**Example: Change column type or constraints**

```python
# Before (in model)
status = Column(String(50), default="pending")

# After (in model) 
status = Column(String(100), default="pending")  # Increased length
```

**Generate and apply migration:**
```bash
silica cron migrate create "increase status column length"
# Alembic will detect the change and generate appropriate SQL

silica cron migrate upgrade
```

### Adding a New Table
**Step 1: Create New Model**
```python
# Add to silica/cron/models/prompt.py or create new file
class JobTemplate(Base):
    """Model for job templates."""
    __tablename__ = "job_templates"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(255), nullable=False, unique=True, index=True)
    description = Column(Text)
    default_cron = Column(String(100), nullable=False)
    created_at = Column(DateTime, server_default=func.now())
```

**Step 2: Update Model Imports**
```python
# Update silica/cron/models/__init__.py
from .prompt import Prompt, ScheduledJob, JobExecution, JobTemplate

__all__ = [
    "Base", "engine", "SessionLocal", "get_db",
    "Prompt", "ScheduledJob", "JobExecution", "JobTemplate"
]
```

**Step 3: Generate and Apply Migration**
```bash
silica cron migrate create "add job templates table"
# Will detect new table creation

silica cron migrate upgrade
# Applies the new table
```

### Adding Relationships
**Example: Add foreign key relationship**

```python
# Add to existing model
class Prompt(Base):
    # ... existing fields ...
    
    # New relationship
    template_id = Column(Integer, ForeignKey("job_templates.id"), nullable=True)
    template = relationship("JobTemplate", back_populates="prompts")

class JobTemplate(Base):
    # ... existing fields ...
    
    # Reverse relationship
    prompts = relationship("Prompt", back_populates="template")
```

```bash
silica cron migrate create "add template relationship to prompts"
silica cron migrate upgrade
```

## Database Management

### Rebuilding Database from Scratch
**When to use:**
- Database got corrupted
- Want to test full migration chain
- Starting fresh after major schema changes

```bash
# WARNING: This destroys all data!
silica cron migrate rebuild
# Output:
# 🗑️  Removed existing database: silica-cron.db
# 🔄 Rebuilding database from migrations...
# Upgrading cron database to head...
# INFO [alembic.runtime.migration] Running upgrade  -> 5d8b746712b6, initial_cron_schema
# INFO [alembic.runtime.migration] Running upgrade 5d8b746712b6 -> fc0bfa77ff5a, add new feature
# INFO [alembic.runtime.migration] Running upgrade fc0bfa77ff5a -> 34065a4cc718, add priority field to prompts
# ✅ Database rebuilt successfully from migrations
```

### Rolling Back Changes
**Rollback one migration:**
```bash
# First, check current state
silica cron migrate current
# Output: 34065a4cc718 (head)

silica cron migrate history
# Output shows migration chain:
# fc0bfa77ff5a -> 34065a4cc718 (head), add priority field to prompts
# 5d8b746712b6 -> fc0bfa77ff5a, add new feature

# Rollback to previous migration
silica cron migrate downgrade fc0bfa77ff5a
# Output:
# Downgrading cron database to fc0bfa77ff5a...
# INFO [alembic.runtime.migration] Running downgrade 34065a4cc718 -> fc0bfa77ff5a, add priority field to prompts
```

**Rollback multiple migrations:**
```bash
# Rollback to initial state
silica cron migrate downgrade base
# Rolls back all migrations

# Rollback specific number of steps
silica cron migrate downgrade -2  # Go back 2 migrations
```

**Re-apply after rollback:**
```bash
# Apply migrations again
silica cron migrate upgrade
# Brings database back to latest state
```

### Seeding Test Data
**Create a data seeding script:**
```python
# scripts/seed_dev_data.py
"""Seed development database with test data."""
import sqlite3

def seed_development_data():
    """Add sample data for development."""
    conn = sqlite3.connect('silica-cron.db')
    cursor = conn.cursor()
    
    # Add sample prompts
    cursor.execute("""
        INSERT OR IGNORE INTO prompts (name, description, prompt_text, model, persona)
        VALUES (?, ?, ?, ?, ?)
    """, (
        "Daily Summary", 
        "Generate daily summary report",
        "Please provide a summary of today's activities",
        "haiku",
        "basic_agent"
    ))
    
    conn.commit()
    conn.close()
    print("✅ Development data seeded")

if __name__ == "__main__":
    seed_development_data()
```

**Use after database rebuild:**
```bash
silica cron migrate rebuild
python scripts/seed_dev_data.py
```

## Collaboration Workflows

### Working on Feature Branch
**Starting new feature:**
```bash
# 1. Create feature branch
git checkout -b feature/add-job-priority

# 2. Ensure database is current
silica cron migrate upgrade

# 3. Make model changes and create migration
# ... edit models ...
silica cron migrate create "add priority features"

# 4. Test migration
silica cron migrate upgrade
# Test application functionality

# 5. Commit migration with code
git add .
git commit -m "feat: add job priority system with database migration"
```

### Merging Feature Branches
**When merging branches with migrations:**

```bash
# 1. Switch to main branch
git checkout main
git pull origin main

# 2. Check for migration conflicts
silica cron migrate history
# Look for multiple migration chains

# 3. If conflicts exist, merge and resolve
git checkout feature/add-job-priority
git rebase main
# May need to adjust migration dependencies

# 4. Test migration chain
silica cron migrate rebuild
# Ensure all migrations apply cleanly

# 5. Merge to main
git checkout main
git merge feature/add-job-priority
```

### Handling Migration Conflicts
**When two branches create migrations:**

```bash
# Problem: Two branches created migrations from same parent
# Branch A: migration_001 -> migration_002_feature_a
# Branch B: migration_001 -> migration_002_feature_b

# Solution 1: Reorder migrations
# Edit the conflicting migration file
# Change: down_revision = 'migration_001'
# To:     down_revision = 'migration_002_feature_a'

# Solution 2: Use merge migrations
silica cron migrate create "merge feature_a and feature_b"
# Manually edit to reference both parents
```

## Testing & Debugging

### Testing Migrations
**Test upgrade path:**
```bash
# Start from clean state
silica cron migrate rebuild

# Apply migrations one by one
silica cron migrate upgrade 5d8b746712b6  # Apply first migration
# Test app functionality

silica cron migrate upgrade fc0bfa77ff5a  # Apply second migration  
# Test app functionality

silica cron migrate upgrade head  # Apply all remaining
# Final functionality test
```

**Test downgrade path:**
```bash
# Test that rollbacks work correctly
silica cron migrate downgrade fc0bfa77ff5a
# Verify data integrity and app still works

silica cron migrate downgrade 5d8b746712b6  
# Continue testing rollbacks

silica cron migrate upgrade  # Back to current
```

### Debugging Migration Issues
**Common debugging commands:**

```bash
# 1. Check current state
silica cron migrate current
silica cron migrate status

# 2. Inspect database directly
sqlite3 silica-cron.db ".schema"
sqlite3 silica-cron.db ".tables"

# 3. Check migration files
ls -la silica/cron/alembic/versions/
# Look at recent migration files

# 4. Validate migration syntax
python -m py_compile silica/cron/alembic/versions/20250817_*.py

# 5. Test with verbose output  
PYTHONPATH=. alembic -c silica/cron/alembic.ini upgrade head --sql
# Shows SQL that would be executed
```

### Creating Test Migrations
**For testing complex changes:**

```bash
# 1. Create test branch
git checkout -b test-migration-safety

# 2. Backup current database
cp silica-cron.db silica-cron-backup.db

# 3. Create and test migration
# ... make changes ...
silica cron migrate create "test complex change"
silica cron migrate upgrade

# 4. Test application thoroughly
silica cron --bind-port 8080
# Test all functionality

# 5. Test rollback
silica cron migrate downgrade -1
# Verify rollback works

# 6. Clean up or keep changes
git checkout main  # Discard
# OR
git checkout main && git merge test-migration-safety  # Keep
```

## Production Considerations

### Pre-Deployment Testing
**Before deploying migrations to production:**

```bash
# 1. Test with production-like data
# Create larger test database or use staging

# 2. Time the migration
time silica cron migrate upgrade
# Ensure migrations are fast enough

# 3. Test rollback scenarios
silica cron migrate downgrade -1
silica cron migrate upgrade

# 4. Check for data loss
# Verify critical data survives migration cycle
```

### Production Deployment Process
**Automatic deployment (recommended):**
```bash
# Production environments auto-migrate
git push production main
# Output will show:
# 🚀 Production detected: auto-applying cron migrations...
# INFO [alembic.runtime.migration] Running upgrade ...
# ✅ cron migrations applied successfully
```

**Manual deployment (if needed):**
```bash
# SSH to production server
ssh production-server

# Run migrations manually
SILICA_ENVIRONMENT=production silica cron migrate upgrade
```

### Production Monitoring
**Check migration status in production:**

```bash
# Via application logs
tail -f /var/log/silica-cron.log | grep migration

# Via direct database connection (if available)
SILICA_ENVIRONMENT=production silica cron migrate current
SILICA_ENVIRONMENT=production silica cron migrate status
```

## Troubleshooting

### Database File Issues
**Problem: Database file missing or corrupted**

```bash
# Symptoms
silica cron migrate status
# Error: database is locked / file not found / corruption error

# Solution: Rebuild from migrations
rm -f silica-cron.db  # Remove corrupted file
silica cron migrate rebuild
```

**Problem: Permission issues**
```bash
# Symptoms
# Error: database is locked
# Permission denied

# Solution: Fix file permissions
chmod 666 silica-cron.db
# OR
sudo chown $USER:$USER silica-cron.db
```

### Migration Errors
**Problem: Migration fails to apply**

```bash
# Symptoms
silica cron migrate upgrade
# ERROR: (sqlite3.OperationalError) table already exists

# Diagnosis
sqlite3 silica-cron.db ".schema"
# Check if table/column already exists

# Solutions:

# Option 1: Mark migration as applied (if schema matches)
silica cron migrate upgrade --stamp-only

# Option 2: Fix database manually
sqlite3 silica-cron.db "DROP TABLE problematic_table;"
silica cron migrate upgrade

# Option 3: Nuclear option - rebuild
silica cron migrate rebuild
```

**Problem: Model and migration out of sync**
```bash
# Symptoms
# Alembic detects changes that shouldn't exist
# OR migration creates things that already exist

# Solution: Generate new migration to sync
silica cron migrate create "sync model and database state"
# Review and edit the generated migration
# Remove unnecessary changes
silica cron migrate upgrade
```

### Development Environment Issues
**Problem: Multiple developers, conflicting migrations**

```bash
# Symptoms
git pull
# Multiple migration files with same parent revision

# Solution: Merge workflow
# 1. Backup database
cp silica-cron.db backup.db

# 2. Reset to common ancestor
silica cron migrate downgrade <common_ancestor_revision>

# 3. Resolve migration dependencies manually
# Edit migration files to create proper chain

# 4. Test the chain
silica cron migrate rebuild
```

**Problem: Can't rollback migration**
```bash
# Symptoms
silica cron migrate downgrade -1
# Error: can't drop column (SQLite limitation)

# Solution: Recreate table approach
# Edit the migration to recreate table instead of altering
def downgrade() -> None:
    # Instead of: op.drop_column('table', 'column')
    # Use table recreation:
    op.rename_table('table', 'table_old')
    op.create_table('table', 
        sa.Column('id', sa.Integer, primary_key=True),
        # ... columns without the removed one ...
    )
    op.execute('INSERT INTO table SELECT id, col1, col2 FROM table_old')
    op.drop_table('table_old')
```

### Performance Issues
**Problem: Migration takes too long**

```bash
# Diagnosis: Check migration SQL
PYTHONPATH=. alembic -c silica/cron/alembic.ini upgrade head --sql
# Review generated SQL for efficiency

# Solutions:
# 1. Add indexes after bulk operations
# 2. Break large migrations into smaller ones
# 3. Use batch operations for large datasets
```

### Getting Help
**When stuck:**

1. **Check migration history:**
   ```bash
   silica cron migrate history
   silica cron migrate current
   ```

2. **Inspect database state:**
   ```bash
   sqlite3 silica-cron.db ".schema"
   sqlite3 silica-cron.db "SELECT * FROM cron_alembic_version;"
   ```

3. **Review recent changes:**
   ```bash
   git log --oneline silica/cron/models/
   git log --oneline silica/cron/alembic/versions/
   ```

4. **Test in isolation:**
   ```bash
   # Create clean test environment
   git stash
   silica cron migrate rebuild
   # Reproduce issue
   ```

5. **Nuclear option (development only):**
   ```bash
   # Complete reset
   rm silica-cron.db
   git checkout HEAD -- silica/cron/models/
   silica cron migrate rebuild
   ```

This guide covers the most common developer activities. For additional help, check the SQLAlchemy and Alembic documentation or consult with the team.